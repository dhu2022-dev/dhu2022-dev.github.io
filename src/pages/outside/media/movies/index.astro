---
import MediaLayout from "../../../../layouts/MediaLayout.astro";
import CreditsRoll from "../../../../components/media/movies/CreditsRoll.astro";
import LibraryMode from "../../../../components/media/movies/LibraryMode.astro";
import Modal from "../../../../components/ui/Modal.astro";

import { getCollection } from "astro:content";
import { render } from "astro:content";

const movies = await getCollection("movies");

// Render markdown bodies to HTML (supported in static builds)
const rendered = await Promise.all(
  movies.map(async (m) => {
    const { Content, body } = await render(m);
    // Use the body string directly if available, otherwise we'll render Content
    return { entry: m, Content, contentHtml: body || "" };
  })
);

// credits roll only needs lightweight info + template id
const items = rendered.map(({ entry }) => ({
  id: entry.id,
  title: entry.data.title,
  year: entry.data.year,
  rating: entry.data.rating,
  poster: entry.data.poster,
  templateId: `movie-${entry.id}`,
}));

// Featured fallback (optional)
const featured = movies.find((m) => m.data.featured) ?? movies[0];
---

<MediaLayout title="Movies · David Hu">
  <h1 style="margin:0 0 8px;">Movies</h1>
  <p style="margin-top:0;">
    My favorite movie of all time is <strong>The Matrix</strong>, and I will die on that hill.
  </p>

  <div class="modeToggleContainer">
    <div class="modeLabel" id="modeLabel">Cinematic Mode</div>
    <button type="button" class="modeToggle" id="modeToggle">
      Switch to Library Mode
    </button>
  </div>

  <style>
    .modeToggleContainer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 16px 0;
      flex-wrap: wrap;
      gap: 10px;
    }
    .modeLabel {
      font-weight: 600;
      color: #111;
    }
    .modeToggle {
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 999px;
      background: #fff;
      color: #111;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s, border-color 0.2s, color 0.2s;
    }
    .modeToggle:hover {
      background: #f5f5f5;
    }
    @media (prefers-color-scheme: dark) {
      .modeLabel {
        color: #fff;
      }
      .modeToggle {
        border-color: #444;
        background: #1a1a1a;
        color: #fff;
      }
      .modeToggle:hover {
        background: #2a2a2a;
      }
    }
  </style>

  <div id="cinematicMode">
    <CreditsRoll items={items} />
  </div>

  <LibraryMode items={items} />

  <!-- Hidden templates the modal will pull from -->
  <div style="display:none;">
    {rendered.map(({ entry, contentHtml }) => (
      <template id={`movie-${entry.id}`}>
        <div style="display:grid; grid-template-columns: 160px 1fr; gap: 14px; align-items:start;">
          {entry.data.poster ? (
            <img
              src={entry.data.poster}
              alt={`${entry.data.title} poster`}
              width="160"
              height="240"
              style="border-radius:12px; object-fit:cover;"
              loading="lazy"
            />
          ) : (
            <div style="width:160px; height:240px; border-radius:12px; background:#eee;"></div>
          )}

          <div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:baseline;">
              <h3 style="margin:0;">{entry.data.title}</h3>
              {entry.data.year ? <span style="opacity:.7;">({entry.data.year})</span> : null}
              {entry.data.rating ? <span style="opacity:.9;">· {entry.data.rating}/10</span> : null}
            </div>

            {entry.data.director ? (
              <p style="margin:6px 0 10px; opacity:.8;">Director: {entry.data.director}</p>
            ) : null}

            {entry.data.tags && entry.data.tags.length ? (
              <div style="display:flex; gap:6px; flex-wrap:wrap; margin: 0 0 10px;">
                {entry.data.tags.map((t) => (
                  <span style="border:1px solid #ddd; border-radius:999px; padding:4px 8px; font-size:12px;">
                    {t}
                  </span>
                ))}
              </div>
            ) : null}

            <div set:html={contentHtml} style="line-height:1.5;"></div>

            {entry.data.link ? (
              <p style="margin-top:12px;">
                <a href={entry.data.link} target="_blank" rel="noreferrer">External link</a>
              </p>
            ) : null}
          </div>
        </div>
      </template>
    ))}
  </div>

  <Modal id="movieModal" title="Movie" />

  <script is:inline>
    (function () {
      var cinematicMode = document.getElementById("cinematicMode");
      var libraryMode = document.getElementById("libraryMode");
      var modeToggle = document.getElementById("modeToggle");
      var modeLabel = document.getElementById("modeLabel");

      if (!cinematicMode || !libraryMode || !modeToggle || !modeLabel) return;

      modeToggle.addEventListener("click", function () {
        var isCinematic = cinematicMode.style.display !== "none";
        
        if (isCinematic) {
          // Switch to Library Mode
          cinematicMode.style.display = "none";
          libraryMode.style.display = "block";
          modeLabel.textContent = "Library Mode";
          modeToggle.textContent = "Switch to Cinematic Mode";
        } else {
          // Switch to Cinematic Mode
          cinematicMode.style.display = "block";
          libraryMode.style.display = "none";
          modeLabel.textContent = "Cinematic Mode";
          modeToggle.textContent = "Switch to Library Mode";
        }
      });
    })();
  </script>
</MediaLayout>
