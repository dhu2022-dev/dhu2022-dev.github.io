---
import MediaLayout from "../../../../layouts/MediaLayout.astro";
import CreditsRoll from "../../../../components/media/movies/CreditsRoll.astro";
import LibraryMode from "../../../../components/media/movies/LibraryMode.astro";
import Modal from "../../../../components/ui/Modal.astro";

import { getCollection } from "astro:content";
import { render } from "astro:content";

const movies = await getCollection("movies");

// Render markdown bodies to HTML (supported in static builds)
const rendered = await Promise.all(
  movies.map(async (m) => {
    const { Content, body } = await render(m);
    // Use the body string directly if available, otherwise we'll render Content
    return { entry: m, Content, contentHtml: body || "" };
  })
);

// credits roll only needs lightweight info + template id
const items = rendered.map(({ entry }) => ({
  id: entry.id,
  title: entry.data.title,
  year: entry.data.year,
  rating: entry.data.rating,
  poster: entry.data.poster,
  templateId: `movie-${entry.id}`,
}));

// Featured fallback (optional)
const featured = movies.find((m) => m.data.featured) ?? movies[0];
---

<MediaLayout title="Movies · David Hu">
  <div class="movies-header">
    <h1>Movies</h1>
    <p class="movies-intro">
      My favorite movie of all time is <strong>The Matrix</strong>, and I will die on that hill.
    </p>
  </div>

  <div class="modeToggleContainer">
    <div class="modeLabel" id="modeLabel">Cinematic Mode</div>
    <button type="button" class="modeToggle" id="modeToggle">
      Switch to Library Mode
    </button>
  </div>

  <style>
    .movies-header {
      margin-bottom: 2rem;
    }
    
    .movies-header h1 {
      margin-bottom: 0.75rem;
    }
    
    .movies-intro {
      font-size: var(--font-size-lg);
      opacity: 0.8;
      margin-bottom: 0;
    }
    
    .modeToggleContainer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 2rem 0;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .modeLabel {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      color: #111;
    }
    
    .modeToggle {
      padding: 0.75rem 1.5rem;
      border: 1px solid #ddd;
      border-radius: 999px;
      background: #fff;
      color: #111;
      cursor: pointer;
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-medium);
      transition: background 0.2s, border-color 0.2s, color 0.2s;
    }
    
    .modeToggle:hover {
      background: #f5f5f5;
    }
    
    @media (prefers-color-scheme: dark) {
      .modeLabel {
        color: #fff;
      }
      
      .modeToggle {
        border-color: #444;
        background: #1a1a1a;
        color: #fff;
      }
      
      .modeToggle:hover {
        background: #2a2a2a;
      }
    }
  </style>

  <div id="cinematicMode">
    <CreditsRoll items={items} />
  </div>

  <LibraryMode items={items} />

  <!-- Hidden templates the modal will pull from -->
  <div style="display:none;">
    {rendered.map(({ entry, contentHtml }) => (
      <template id={`movie-${entry.id}`}>
        <div style="display:grid; grid-template-columns: 160px 1fr; gap: 14px; align-items:start;">
          {entry.data.poster ? (
            <img
              src={entry.data.poster}
              alt={`${entry.data.title} poster`}
              width="160"
              height="240"
              style="border-radius:12px; object-fit:cover;"
              loading="lazy"
            />
          ) : (
            <div style="width:160px; height:240px; border-radius:12px; background:#eee;"></div>
          )}

          <div>
            <div class="movieHeader">
              <h3 class="movieTitle">{entry.data.title}</h3>
              {entry.data.year ? <span class="movieMeta">({entry.data.year})</span> : null}
              {entry.data.rating ? <span class="movieMeta">· {entry.data.rating}/10</span> : null}
            </div>

            {entry.data.director ? (
              <p class="movieDirector">Director: {entry.data.director}</p>
            ) : null}

            {entry.data.tags && entry.data.tags.length ? (
              <div class="movieTags">
                {entry.data.tags.map((t) => (
                  <span class="movieTag">{t}</span>
                ))}
              </div>
            ) : null}

            <div class="movieContent" set:html={contentHtml}></div>

            {entry.data.link ? (
              <p class="movieLink">
                <a href={entry.data.link} target="_blank" rel="noreferrer">External link</a>
              </p>
            ) : null}
          </div>
        </div>
      </template>
    ))}
  </div>

  <Modal id="movieModal" title="Movie" />

  <script is:inline>
    (function () {
      var cinematicMode = document.getElementById("cinematicMode");
      var libraryMode = document.getElementById("libraryMode");
      var modeToggle = document.getElementById("modeToggle");
      var modeLabel = document.getElementById("modeLabel");

      if (!cinematicMode || !libraryMode || !modeToggle || !modeLabel) return;

      modeToggle.addEventListener("click", function () {
        var isCinematic = cinematicMode.style.display !== "none";
        
        if (isCinematic) {
          // Switch to Library Mode
          cinematicMode.style.display = "none";
          libraryMode.style.display = "block";
          modeLabel.textContent = "Library Mode";
          modeToggle.textContent = "Switch to Cinematic Mode";
        } else {
          // Switch to Cinematic Mode
          cinematicMode.style.display = "block";
          libraryMode.style.display = "none";
          modeLabel.textContent = "Cinematic Mode";
          modeToggle.textContent = "Switch to Library Mode";
        }
      });
    })();
  </script>
  
  <style>
    .movieHeader {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: baseline;
      margin-bottom: 0.5rem;
    }
    
    .movieTitle {
      margin: 0;
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
    }
    
    .movieMeta {
      opacity: 0.7;
      font-size: var(--font-size-base);
    }
    
    .movieDirector {
      margin: 0.5rem 0 0.75rem;
      opacity: 0.8;
      font-size: var(--font-size-base);
    }
    
    .movieTags {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin: 0 0 1rem;
    }
    
    .movieTag {
      border: 1px solid #ddd;
      border-radius: 999px;
      padding: 0.25rem 0.5rem;
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
    }
    
    @media (prefers-color-scheme: dark) {
      .movieTag {
        border-color: #444;
      }
    }
    
    .movieContent {
      line-height: var(--line-height-relaxed);
      font-size: var(--font-size-base);
    }
    
    .movieLink {
      margin-top: 1rem;
      font-size: var(--font-size-base);
    }
  </style>
</MediaLayout>
